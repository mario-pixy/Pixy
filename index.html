<!doctype html>
<html lang="it">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pixy</title>
<style>
body{
  margin:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  overflow:hidden;
}
  #face{
  display:flex;
  flex-direction:row;
  align-items:center;
}
.eye{
  width:90px;
  height:90px;
  background:cyan;
  margin:25px;
  border-radius:20px;
  box-shadow:0 0 50px cyan;
  transition:all .2s ease;
}
.speaking .eye{
  height:120px;
  box-shadow:0 0 80px cyan;
}
.listening .eye{
  height:60px;
  box-shadow:0 0 90px cyan;
  transform:scaleX(1.2);
}
</style>
</head>
<body>

<div id="face">
  <div class="eye"></div>
  <div class="eye"></div>
</div>

<script>
const face = document.getElementById("face");

function setState(state){
  face.classList.remove("listening","speaking");
  if(state==="listening") face.classList.add("listening");
  if(state==="speaking") face.classList.add("speaking");
}

async function sendToPixy(text){
  try{
    setState("speaking");

    const r = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const data = await r.json();
    const reply = (data.text || "").trim();
    const finalReply = reply || "Ok.";

    const u = new SpeechSynthesisUtterance(finalReply);
    u.lang = "it-IT";
    u.onend = () => setState("idle");

    speechSynthesis.cancel();
    speechSynthesis.speak(u);

  } catch(e){
    setState("idle");
    alert("Errore: " + e);
  }
}

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

function startListening(){
  if(!SR){
    const t = prompt("Scrivi a Pixy:");
    if(t && t.trim()) sendToPixy(t.trim());
    return;
  }

  if(!recognition){
    recognition = new SR();
    recognition.lang = "it-IT";
    recognition.interimResults = false;
    recognition.continuous = false;

    recognition.onstart = () => setState("listening");
    recognition.onend = () => setState("idle");

    recognition.onresult = (event) => {
      const spoken = event.results?.[0]?.[0]?.transcript || "";
      const t = spoken.trim();
      if(t) sendToPixy(t);
    };
  }

  recognition.start();
}

document.body.addEventListener("click", startListening);
setState("idle");
</script>

</body>
</html>
